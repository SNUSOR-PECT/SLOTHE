// ref: https://github.com/lattera/glibc/blob/master/sysdeps/ieee754/dbl-64/s_tanh.c

#include <stdlib.h>
#include <math.h>

// Degree 1 approximation of f(x) = erf(x) on interval [ -4, 4 ]
// p(x)=2.4999999614568552e-1*x-3.0042359989771989e-1
// Estimated max error: 4.7521427371018039e-1
double erf_1(double x)
{
    double u = 0.24999999614568552;
    return u * x + -0.30042359989771988;
}

// Degree 7 approximation of f(x) = erf(x) on interval [ -4, 4 ]
// p(x)=((((((-4.0996323337992315e-4*x+3.4123547930888997e-90)*x+1.4134263692335549e-2)*x-1.8629569714914913e-89)*x-1.6786831965271229e-1)*x+2.3559745275765197e-89)*x+9.8444933319099659e-1)*x-4.4334255913994753e-90
// Estimated max error: 4.9126704337401337e-2
double erf_7(double x)
{
    double u = -0.00040996323337992314;
    u = u * x + 3.4123547930888996e-90;
    u = u * x + 0.014134263692335549;
    u = u * x + -1.8629569714914913e-89;
    u = u * x + -0.16786831965271229;
    u = u * x + 2.3559745275765197e-89;
    u = u * x + 0.98444933319099659;
    return u * x + -4.4334255913994749e-90;
}

// Degree 11 approximation of f(x) = erf(x)
// on interval [ -4, 4 ]
// p(x)=((((((((((-5.1447943824093267e-6*x-7.5123182066045901e-101)*x+2.6505904755152703e-4)*x+2.0003156480019846e-99)*x-5.3412557717871112e-3)*x-1.7615253596540876e-98)*x+5.3877143321320023e-2)*x+5.8175627547381414e-98)*x-2.9615340160788693e-1)*x-5.9857559691496273e-98)*x+1.0953156572749406)*x+8.6150320174992798e-99
// Estimated max error: 8.6875582855363712e-3
double erf_11(double x)
{
    double u = -5.1447943824093266e-06;
    u = u * x + -7.5123182066045896e-101;
    u = u * x + 0.000265059047551527;
    u = u * x + 2.0003156480019847e-99;
    u = u * x + -0.0053412557717871113;
    u = u * x + -1.7615253596540877e-98;
    u = u * x + 0.053877143321320022;
    u = u * x + 5.8175627547381414e-98;
    u = u * x + -0.29615340160788695;
    u = u * x + -5.9857559691496273e-98;
    u = u * x + 1.0953156572749405;
    return u * x + 8.6150320174992798e-99;
}

// Degree 17 approximation of f(x) = erf(x)
// on interval [ -4, 4 ]
// p(x)=((((((((((((((((4.4227365886800202e-9*x+5.8888838438997774e-93)*x-3.4466526075659853e-7)*x-2.3388214662328974e-91)*x+1.1509018111642994e-5)*x+3.6046255045875613e-90)*x-2.1624906543010323e-4)*x-2.7414538270814514e-89)*x+2.5324569979904599e-3)*x+1.0853876981971381e-88)*x-1.944189925459961e-2)*x-2.1794059520258016e-88)*x+1.009971823468719e-1)*x+2.0175680057647987e-88)*x-3.6721742876252938e-1)*x-6.9434682058011235e-89)*x+1.1263790498673853)*x+4.2079292518655572e-90
// Estimated max error: 3.8676376305221955e-4
double erf_17(double x)
{
    double u = 4.4227365886800198e-09;
    u = u * x + 5.8888838438997773e-93;
    u = u * x + -3.4466526075659851e-07;
    u = u * x + -2.3388214662328974e-91;
    u = u * x + 1.1509018111642993e-05;
    u = u * x + 3.6046255045875613e-90;
    u = u * x + -0.00021624906543010324;
    u = u * x + -2.7414538270814514e-89;
    u = u * x + 0.00253245699799046;
    u = u * x + 1.0853876981971381e-88;
    u = u * x + -0.019441899254599611;
    u = u * x + -2.1794059520258015e-88;
    u = u * x + 0.1009971823468719;
    u = u * x + 2.0175680057647987e-88;
    u = u * x + -0.36721742876252939;
    u = u * x + -6.9434682058011238e-89;
    u = u * x + 1.1263790498673854;
    return u * x + 4.207929251865557e-90;
}

// Degree 21 approximation of f(x) = erf(x)
// on interval [ -4, 4 ]
// p(x)=((((((((((((((((((((2.8409145253208106e-11*x+2.7126622703510328e-120)*x-2.7194467026262892e-9)*x-1.8008476463273185e-118)*x+1.1518899134560877e-7)*x+5.0205241693567143e-117)*x-2.8545898671629189e-6)*x-7.6443396025228023e-116)*x+4.6199012325346445e-5)*x+6.9253710454812645e-115)*x-5.1758759752665276e-4)*x-3.814551541502067e-114)*x+4.1658597378998974e-3)*x+1.2531010023832727e-113)*x-2.4739571396542839e-2)*x-2.308470027172408e-113)*x+1.1039177494664311e-1)*x+2.0989362079579871e-113)*x-3.7480479541639208e-1)*x-7.1487257178082089e-114)*x+1.1281664651341317)*x+3.8716838975794802e-115
// Estimated max error: 3.4820987088870801e-5
double erf_21(double x)
{
    double u = 2.8409145253208105e-11;
    u = u * x + 2.712662270351033e-120;
    u = u * x + -2.7194467026262893e-09;
    u = u * x + -1.8008476463273184e-118;
    u = u * x + 1.1518899134560877e-07;
    u = u * x + 5.0205241693567144e-117;
    u = u * x + -2.8545898671629187e-06;
    u = u * x + -7.6443396025228029e-116;
    u = u * x + 4.6199012325346448e-05;
    u = u * x + 6.9253710454812643e-115;
    u = u * x + -0.00051758759752665274;
    u = u * x + -3.8145515415020674e-114;
    u = u * x + 0.0041658597378998975;
    u = u * x + 1.2531010023832727e-113;
    u = u * x + -0.024739571396542839;
    u = u * x + -2.308470027172408e-113;
    u = u * x + 0.11039177494664311;
    u = u * x + 2.0989362079579871e-113;
    u = u * x + -0.37480479541639211;
    u = u * x + -7.1487257178082085e-114;
    u = u * x + 1.1281664651341317;
    return u * x + 3.8716838975794801e-115;
}

double gelu(double x) {
    return x / 2 * (1 + erf(x / sqrt(2)));
}

double gelu_depth1(double x) {
    return x / 2 * (1 + erf_21(x / sqrt(2)));
}

// Degree 1 approximation of f(x) = exp(x/8) on interval [ -8, 8 ]
// Estimated max error: 2.7880158579550234e-1
double exp_inv_1(double x)
{
    double u = 0.14690014920547517;
    return u * x + 1.2642790490197415;
}
// Degree 2 approximation of f(x) = exp(x/8) on interval [ -8, 8 ]
// Estimated max error: 4.5017388402819014e-2
double exp_inv_2(double x)
{
    double u = 0.0086568891618262252;
    u = u * x + 0.14127297565512281;
    return u * x + 0.9890397284583653;
}
// Degree 3 approximation of f(x) = exp(x/8) on interval [ -8, 8 ]
// Estimated max error: 5.5283701086875885e-3
double exp_inv_3(double x)
{
    double u = 0.00035065133518781734;
    u = u * x + 0.0084839498184665855;
    u = u * x + 0.12445846375345487;
    return u * x + 0.99457947632469468;
}
// Degree 4 approximation of f(x) = exp(x/8) on interval [ -8, 8 ]
// Estimated max error: 5.4666760051379795e-4
double exp_inv_4(double x)
{
    double u = 1.0780155669648492e-05;
    u = u * x + 0.00034637748900164303;
    u = u * x + 0.0077942987045349363;
    u = u * x + 0.1246636564593058;
    return u * x + 1.0000900001021276;
}
// Degree 5 approximation of f(x) = exp(x/8) on interval [ -8, 8 ]
// Estimated max error: 4.5205511926115826e-5
double exp_inv_5(double x)
{
    double u = 2.6666842656053289e-07;
    u = u * x + 1.0691820403827191e-05;
    u = u * x + 0.00032504815651124286;
    u = u * x + 0.0077999528536713894;
    u = u * x + 0.12500479331356371;
    return u * x + 1.0000447502942726;
}
// Degree 6 approximation of f(x) = exp(x/8) on interval [ -8, 8 ]
// Estimated max error: 3.2108771033611466e-6
double exp_inv_6(double x)
{
    double u = 5.5147874420177263e-09;
    u = u * x + 2.6510006564821646e-07;
    u = u * x + 1.0162456168166248e-05;
    u = u * x + 0.00032517363418001693;
    u = u * x + 0.0078126553818993628;
    u = u * x + 0.12500278538942108;
    return u * x + 0.99999960146967537;
}
// Degree 7 approximation of f(x) = exp(x/8) on interval [ -8, 8 ]
// Estimated max error: 1.9982527697547409e-7
double exp_inv_7(double x)
{
    double u = 9.7946179621941935e-11;
    u = u * x + 5.4903884088928207e-09;
    u = u * x + 2.541307650672302e-07;
    u = u * x + 1.0164798576098333e-05;
    u = u * x + 0.00032552461957565293;
    u = u * x + 0.0078125991600794514;
    u = u * x + 0.1249999779356072;
    return u * x + 0.99999980139812239;
}
// Degree 8 approximation of f(x) = exp(x/8) on interval [ -8, 8 ]
// Estimated max error: 1.1064289311752762e-8
double exp_inv_8(double x)
{
    double u = 1.5240798495095524e-12;
    u = u * x + 9.7608458450598704e-11;
    u = u * x + 5.2953136375575388e-09;
    u = u * x + 2.5416859089170512e-07;
    u = u * x + 1.017260114989744e-05;
    u = u * x + 0.00032552340909871913;
    u = u * x + 0.0078124992951386744;
    u = u * x + 0.12499998762009649;
    return u * x + 1.0000000011013483;
}
// Degree 9 approximation of f(x) = exp(x/8) on interval [ -8, 8 ]
// Estimated max error: 5.5172466939350217e-10
double exp_inv_9(double x)
{
    double u = 2.1098698085983081e-14;
    u = u * x + 1.5198698902778767e-12;
    u = u * x + 9.4570322004214351e-11;
    u = u * x + 5.2958525224794877e-09;
    u = u * x + 2.5431441657319724e-07;
    u = u * x + 1.017257959393278e-05;
    u = u * x + 0.00032552081676327728;
    u = u * x + 0.0078124995710659208;
    u = u * x + 0.12500000006243503;
    return u * x + 1.0000000005494576;
}

// Degree 15 approximation of f(x) = exp(x)
// on interval [ -8, 8 ]
// p(x)=((((((((((((((2.1347933669654444e-12*x+3.2246970421738508e-11)*x-2.8462589448106964e-11)*x-4.1669566760104026e-10)*x+3.7958775994285677e-8)*x+4.2132604434418511e-7)*x+2.2652325774980805e-6)*x+2.0236501050563404e-5)*x+2.0891033993638475e-4)*x+1.4654247003862545e-3)*x+8.2141712465480412e-3)*x+4.1041720222194951e-2)*x+1.6727699688056654e-1)*x+5.019338538299158e-1)*x+9.9907996327451231e-1)*x+9.9902171452990445e-1
// Estimated max error: 1.082120710159185e-3
double g15(double x)
{
    double u = 2.1347933669654444e-12;
    u = u * x + 3.2246970421738508e-11;
    u = u * x + -2.8462589448106963e-11;
    u = u * x + -4.1669566760104027e-10;
    u = u * x + 3.7958775994285675e-08;
    u = u * x + 4.2132604434418509e-07;
    u = u * x + 2.2652325774980806e-06;
    u = u * x + 2.0236501050563403e-05;
    u = u * x + 0.00020891033993638476;
    u = u * x + 0.0014654247003862545;
    u = u * x + 0.0082141712465480417;
    u = u * x + 0.041041720222194954;
    u = u * x + 0.16727699688056655;
    u = u * x + 0.50193385382991584;
    u = u * x + 0.99907996327451232;
    return u * x + 0.9990217145299044;
}

// Estimated max error: 3.2870501857961531e-2
double tanh_15(double x)
{
    double u = -2.2642920914480758e-11;
    u = u * x + 0.0;
    u = u * x + 5.7259420120632315e-09;
    u = u * x + 0.0;
    u = u * x + -5.8930567915451826e-07;
    u = u * x + 0.0;
    u = u * x + 3.1748646806009152e-05;
    u = u * x + 0.0;
    u = u * x + -0.0009606227839164624;
    u = u * x + 0.0;
    u = u * x + 0.016368886821357127;
    u = u * x + 0.0;
    u = u * x + -0.15298707264416264;
    u = u * x + 0.0;
    u = u * x + 0.89573255135594454;
    return u * x + 0.0;
}

typedef union
{
	double value;
	struct
	{
		unsigned int lsw;
		unsigned int msw;
	} parts;
	unsigned long long word;
} ieee_double_shape_type;

#define EXTRACT_WORDS(ix0, ix1, d) \
	do { \
		ieee_double_shape_type ew_u; \
		ew_u.value = (d); \
		(ix0) = ew_u.parts.msw; \
		(ix1) = ew_u.parts.lsw; \
	} while (0)

static const double one = 1.0, two = 2.0, tiny = 1.0e-300;

double _expm1 (double x) {
    double e = exp_inv_7(x);
    e = pow(e, 8); // exp(x)
    return e - 1.0;
}

double _tanh (double x) {
	double t, z;
	int32_t jx, ix, lx;

	/* High word of |x|. */
	EXTRACT_WORDS (jx, lx, x);
	ix = jx & 0x7fffffff;

	// /* x if INF of NaN */
	// if (ix >= 0x7ff00000)
	// {
	// 	if (jx >= 0)
	// 		return one / x + one; 		/* tanh(+-inf)=+-1 */
	// 	else
	// 		return one / x - one;		/* tanh(NaN) = NaN */
	// }

	/* |x| < 22 */
	if (ix < 0x40360000)		/* |x| < 22 */
	{
		// if ((ix | lx) == 0)
		// 	return x;	/* x == +-0 */
		// if (ix < 0x3c800000)	/* |x| < 2**-55 */
		// {
		// 	// math_check_force_underflow (x);
		// 	return x * (one + x);		/* tanh(small) = small */
		// }
		if (ix >= 0x3ff00000) 	/* |x| >= 1 */
		{
			t = _expm1(two * fabs(x));
			z = one - two / (t + two);	
		}
		else
		{
			t = _expm1(-two * fabs(x));
			z = -t / (t + two);
		}
		/* |x| > 22, return +-1 */
	}
	else
		z = one - tiny;		/* raised inexact flag */

	return (jx >= 0) ? z : -z;
}
